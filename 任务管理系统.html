import React, { useState, useEffect, useMemo, useCallback } from 'react';
// The cloudbase SDK is now loaded dynamically in a useEffect hook to prevent build errors.
import { Plus, Loader, X, Edit, Check, Archive, CheckCircle, MessageSquare, Download, Upload, BarChart2, Ban, AlertTriangle, Bell, Trash2, Settings } from 'lucide-react';

// --- Tencent Cloud Base (TCB) Configuration ---
// è¯·åœ¨è¿™é‡Œæ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„è…¾è®¯äº‘ç¯å¢ƒID
const cloudbaseConfig = {
    env: "cloud1-8gap9b2kd3ba5938" 
};

// --- Initial Constants for Dropdowns (will be used if Firestore data is not available) ---
const INITIAL_DEPARTMENTS = ["ç¯ä¿æŠ€æœ¯å’¨è¯¢äº‹ä¸šéƒ¨", "æ°´åœŸæŠ€æœ¯å’¨è¯¢äº‹ä¸šéƒ¨", "èƒ½æºåŒç¢³æŠ€æœ¯å’¨è¯¢äº‹ä¸šéƒ¨"];
const INITIAL_SALES_PERSONS = ["å•é¹", "ç¨‹æ™¨", "ç‹å…‰è€€", "å¼ ç»´æ°", "å¼ å¿—é‘«", "æé”¦é’Š", "åˆ˜äºšæ°", "å¼ é¹èˆª", "éŸ©å¼€å³°", "æ¨Šå¸¸åºœ", "ç‹å°‘æ¥ ", "è‘£å¼º", "æçŒ›æ£®"];
const INITIAL_PROJECT_MANAGERS = ["éƒ­äº®", "ææµ·æ¸…", "èŒƒé¡ºä¸½", "ç‹å®‰é¾™", "éƒ­è´è´", "é­è¿›å®‡", "è‹æ–°ä¸º", "å†¯è…¾æ³¢", "ç‰›æ™“é¾™", "è‹Œæ™“æ—", "è°·æ˜¥è¶…", "ç¿Ÿç»°", "ç‹ä¼¯å‹‹", "å†¯è…¾è…¾", "æä¸–åš", "ç¨‹è‹—è‹—", "åˆ˜é¹é£"];
const TASK_TYPES = ["ç¯è¯„æŠ¥å‘Šè¡¨", "ç¯è¯„æŠ¥å‘Šä¹¦", "ç¯è¯„ç™»è®°è¡¨", "æ’æ±¡è®¸å¯è¯ç”³è¯·", "æ’æ±¡è®¸å¯è¯å˜æ›´", "æ’æ±¡è®¸å¯è¯å»¶ç»­", "æ’æ±¡è®¸å¯ç™»è®°", "çªå‘ç¯å¢ƒåº”æ€¥é¢„æ¡ˆ", "æ‰§è¡ŒæŠ¥å‘Š", "æ±¡æŸ“æºæ•°æ®å¡«æŠ¥", "ç¯è¯„éªŒæ”¶", "æ¸…æ´ç”Ÿäº§å®¡æ ¸", "æ¸…æ´ç”Ÿäº§éªŒæ”¶", "ä¸€å‚ä¸€ç­–", "è®¾å¤‡æ‹†é™¤æ±¡æŸ“é˜²æ²»æ–¹æ¡ˆ", "è®¾å¤‡æ‹†é™¤æ±¡æŸ“é˜²æ²»åº”æ€¥é¢„æ¡ˆ", "è®¾å¤‡æ‹†é™¤æ±¡æŸ“é˜²æ²»æŠ¥å‘Š", "åœŸå£¤éšæ‚£æ’æŸ¥æ–¹æ¡ˆ", "åœŸå£¤éšæ‚£æ’æŸ¥æŠ¥å‘Š", "åœŸå£¤è‡ªè¡Œç›‘æµ‹æ–¹æ¡ˆ", "åœŸå£¤è‡ªè¡Œç›‘æµ‹æŠ¥å‘Š", "åœŸå£¤æ±¡æŸ“çŠ¶å†µè°ƒæŸ¥æ–¹æ¡ˆ", "åœŸå£¤æ±¡æŸ“çŠ¶å†µè°ƒæŸ¥æŠ¥å‘Š", "åœŸå£¤æ±¡æŸ“é£é™©è¯„ä¼°æŠ¥å‘Š", "åœŸå£¤ä¿®å¤æ–¹æ¡ˆ", "åœŸå£¤ä¿®å¤å·¥ç¨‹", "çŸ¿å±±ä¿®å¤æ–¹æ¡ˆ", "å±åºŸé‰´åˆ«", "æ°´åœŸä¿æŒæ–¹æ¡ˆæŠ¥å‘Šè¡¨", "æ°´åœŸä¿æŒæ–¹æ¡ˆæŠ¥å‘Šä¹¦", "æ°´åœŸä¿æŒç›‘æµ‹", "æ°´åœŸä¿æŒéªŒæ”¶", "æ°´å¹³è¡¡æŠ¥å‘Šè¡¨", "æ°´å¹³è¡¡æŠ¥å‘Šä¹¦", "æ°´èµ„æºè®ºè¯", "æ’æ±¡å£è®ºè¯", "ç¤¾ç¨³è¯„ä¼°", "èŠ‚èƒ½è¯„ä¼°", "èƒ½æºå®¡è®¡", "å¯ç ”æŠ¥å‘Š", "å¤‡æ¡ˆæŠ¥å‘Š", "ç¢³æ’æ”¾æ ¸ç®—", "ç¢³æ’æ”¾æ ¸æŸ¥", "ç¢³æ’æ”¾æºæ¸…å•"];

// --- Helper Functions ---
const formatDate = (date) => {
    if (!date) return '';
    const jsDate = new Date(date);
    try {
        return jsDate.toISOString().split('T')[0];
    } catch (e) {
        return '';
    }
};

const formatDateTime = (date) => {
    if (!date) return '';
    const jsDate = new Date(date);
    try {
        return jsDate.toLocaleString('zh-CN');
    } catch (e) {
        return '';
    }
};

const SCRIPTS = {
    tcb: 'https://unpkg.com/@cloudbase/js-sdk@2.10.1/dist/cloudbase.full.js',
    xlsx: 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js',
    jspdf: 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
    jspdfAutotable: 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js',
    html2canvas: 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js',
};

const loadScript = (src) => {
    return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
            return resolve();
        }
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`Failed to load script ${src}`));
        document.head.appendChild(script);
    });
};

// --- Generic Export Function ---
const exportData = async (format, tasksToExport, fileName) => {
    const dataForExport = tasksToExport.map(task => ({
        "ä»»åŠ¡ç¼–å·": task.customTaskId, "é¡¹ç›®åç§°": task.projectName, "ä»»åŠ¡ç±»å‹": task.taskType, "æ‰€å±éƒ¨é—¨": task.department,
        "åˆåŒé‡‘é¢": task.contractAmount, "å•ä½": task.contractUnit, "ä¸šåŠ¡äººå‘˜": task.salesPerson, "é¡¹ç›®è´Ÿè´£äºº": task.projectManager,
        "ä»»åŠ¡ä¸‹è¾¾æ—¶é—´": formatDate(task.createdAt), "åˆåŒè§„å®šå®Œæˆæ—¥æœŸ": formatDate(task.contractualDueDate), "å®é™…å®Œæˆæ—¥æœŸ": formatDate(task.actualCompletionDate),
        "æœ€æ–°è¿›å±•": (task.progressDetails && task.progressDetails.length > 0) ? task.progressDetails.sort((a,b) => b.timestamp - a.timestamp)[0].text : "",
        "æ˜¯å¦å­˜æ¡£": task.isArchived ? "æ˜¯" : "å¦", "çŠ¶æ€": task.status
    }));

    if (dataForExport.length === 0) {
        alert("æ²¡æœ‰å¯å¯¼å‡ºçš„ä»»åŠ¡ã€‚");
        return;
    }

    try {
        if (format === 'excel') {
            await loadScript(SCRIPTS.xlsx);
            const ws = window.XLSX.utils.json_to_sheet(dataForExport);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, "Tasks");
            window.XLSX.writeFile(wb, `${fileName}_${formatDate(new Date())}.xlsx`);
        } else if (format === 'pdf') {
            await loadScript(SCRIPTS.jspdf);
            await loadScript(SCRIPTS.jspdfAutotable);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            
            // NOTE: jsPDF requires a custom font for CJK support. This is a complex setup.
            // This implementation uses a standard font and may result in garbled characters.
            const head = [Object.keys(dataForExport[0])];
            const body = dataForExport.map(Object.values);
            doc.autoTable({ head, body });
            doc.save(`${fileName}_${formatDate(new Date())}.pdf`);
        } else if (format === 'png') {
            alert("å›¾ç‰‡å¯¼å‡ºåŠŸèƒ½å°†æ•è·å½“å‰ä¸»åˆ—è¡¨çš„è§†å›¾ã€‚è¯·ç¡®ä¿æ‚¨æƒ³å¯¼å‡ºçš„æ•°æ®æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚");
            await loadScript(SCRIPTS.html2canvas);
            const table = document.getElementById('task-table-for-export');
            if (!table) { alert("æ‰¾ä¸åˆ°è¦å¯¼å‡ºçš„è¡¨æ ¼ã€‚"); return; }
            const canvas = await window.html2canvas(table);
            const image = canvas.toDataURL("image/png", 1.0);
            const link = document.createElement('a');
            link.download = `${fileName}_${formatDate(new Date())}.png`;
            link.href = image;
            link.click();
        }
    } catch (error) {
        console.error("Export error:", error);
        alert(`å¯¼å‡ºä¸º ${format} å¤±è´¥ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚`);
    }
};


// --- Task Modal Component for Add/Edit ---
const TaskModal = ({ isOpen, onClose, onSave, task, error, setError, managementData }) => {
    const [formData, setFormData] = useState({});
    
    useEffect(() => {
        if (isOpen) {
            setError(null);
            const initialData = {
                customTaskId: 'HB', projectName: '', taskType: '', department: '',
                contractAmount: '', contractUnit: 'å…ƒ', salesPerson: '', projectManager: '',
                isArchived: false, status: 'inprogress', contractualDueDate: '', actualCompletionDate: '', 
                progressDetails: [], createdAt: new Date(),
            };
            if (task) {
                setFormData({ ...initialData, ...task, contractAmount: task.contractAmount || '', contractualDueDate: formatDate(task.contractualDueDate), actualCompletionDate: formatDate(task.actualCompletionDate), createdAt: task.createdAt ? new Date(task.createdAt) : new Date() });
            } else { setFormData(initialData); }
        }
    }, [task, isOpen, setError]);

    if (!isOpen) return null;
    const handleChange = (e) => { const { name, value, type, checked } = e.target; setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value })); };
    const handleSubmit = (e) => { e.preventDefault(); if (!task && !formData.customTaskId) { setError("ä»»åŠ¡ç¼–å·æ˜¯å¿…å¡«é¡¹ã€‚"); return; } onSave(formData, !!task); };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col text-gray-800">
                <header className="flex justify-between items-center p-4 border-b border-gray-200">
                    <h2 className="text-xl font-bold text-gray-900">{task ? 'ç¼–è¾‘ä»»åŠ¡è¯¦æƒ…' : 'åˆ›å»ºæ–°ä»»åŠ¡'}</h2>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100"><X className="text-gray-500" /></button>
                </header>
                <form onSubmit={handleSubmit} className="p-6 overflow-y-auto">
                    {error && <div className="mb-4 bg-red-100 border border-red-300 text-red-800 px-4 py-2 rounded-lg text-center text-sm">{error}</div>}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">ä»»åŠ¡ç¼–å·</label><input type="text" name="customTaskId" value={formData.customTaskId || ''} onChange={handleChange} disabled={!!task} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-200 disabled:cursor-not-allowed" required /></div>
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">é¡¹ç›®åç§°</label><input type="text" name="projectName" value={formData.projectName || ''} onChange={handleChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" required /></div>
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">ä¸šåŠ¡äººå‘˜</label><select name="salesPerson" value={formData.salesPerson || ''} onChange={handleChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500"><option value="" disabled>è¯·é€‰æ‹©ä¸šåŠ¡äººå‘˜</option>{managementData.salesPersons.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                        </div>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">é¡¹ç›®è´Ÿè´£äºº</label><select name="projectManager" value={formData.projectManager || ''} onChange={handleChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500"><option value="" disabled>è¯·é€‰æ‹©é¡¹ç›®è´Ÿè´£äºº</option>{managementData.projectManagers.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">ä»»åŠ¡ç±»å‹</label><input list="task-types" name="taskType" value={formData.taskType || ''} onChange={handleChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="è¯·é€‰æ‹©æˆ–è¾“å…¥ä»»åŠ¡ç±»å‹" /><datalist id="task-types">{TASK_TYPES.map(t => <option key={t} value={t} />)}</datalist></div>
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">æ‰€å±éƒ¨é—¨</label><select name="department" value={formData.department || ''} onChange={handleChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500"><option value="" disabled>è¯·é€‰æ‹©æ‰€å±éƒ¨é—¨</option>{managementData.departments.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                        </div>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">åˆåŒé‡‘é¢</label><div className="flex"><input type="number" name="contractAmount" value={formData.contractAmount || ''} onChange={handleChange} className="w-full bg-gray-50 border border-gray-300 rounded-l-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="è¯·è¾“å…¥é‡‘é¢" /><select name="contractUnit" value={formData.contractUnit || 'å…ƒ'} onChange={handleChange} className="bg-gray-100 border-t border-b border-r border-gray-300 rounded-r-md px-2 focus:ring-2 focus:ring-indigo-500"><option>å…ƒ</option><option>ä¸‡å…ƒ</option></select></div></div>
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">ä»»åŠ¡ä¸‹è¾¾æ—¥æœŸ</label><input type="date" name="createdAt" value={formatDate(formData.createdAt)} onChange={(e) => setFormData({...formData, createdAt: new Date(e.target.value)})} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" /></div>
                            <div><label className="block text-sm font-medium text-gray-600 mb-1">åˆåŒè§„å®šå®Œæˆæ—¥æœŸ</label><input type="date" name="contractualDueDate" value={formData.contractualDueDate || ''} onChange={handleChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" /></div>
                        </div>
                    </div>
                    <footer className="mt-8 pt-4 border-t border-gray-200 flex justify-end gap-4"><button type="button" onClick={onClose} className="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">å–æ¶ˆ</button><button type="submit" className="px-6 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 font-semibold">ä¿å­˜</button></footer>
                </form>
            </div>
        </div>
    );
};

// --- Progress Modal ---
const ProgressModal = ({ isOpen, onClose, onSave, task }) => {
    const [newProgress, setNewProgress] = useState('');
    const sortedProgress = useMemo(() => {
        if (!task || !Array.isArray(task.progressDetails)) return [];
        return [...task.progressDetails].sort((a, b) => b.timestamp - a.timestamp);
    }, [task]);
    if (!isOpen) return null;
    const handleSave = () => { if (newProgress.trim()) { onSave(task._id, newProgress.trim()); setNewProgress(''); onClose(); } };
    return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col text-gray-800"><header className="flex justify-between items-center p-4 border-b border-gray-200"><h2 className="text-xl font-bold text-gray-900">é¡¹ç›®è¿›å±•æ—¥å¿—</h2><button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100"><X className="text-gray-500" /></button></header><div className="p-6 flex-grow overflow-y-auto"><h3 className="text-lg font-semibold text-gray-700 mb-4">å†å²è®°å½•</h3><div className="space-y-4 max-h-60 overflow-y-auto pr-2">{sortedProgress.length > 0 ? sortedProgress.map((entry, index) => (<div key={index} className="bg-gray-100 p-3 rounded-lg"><p className="text-gray-800">{entry.text}</p><p className="text-xs text-gray-500 mt-2 text-right">{formatDateTime(entry.timestamp)}</p></div>)) : <p className="text-gray-500">æš‚æ— å†å²è®°å½•ã€‚</p>}</div><div className="mt-6"><label className="block text-sm font-medium text-gray-600 mb-2">æ·»åŠ æ–°è¿›å±•</label><textarea value={newProgress} onChange={(e) => setNewProgress(e.target.value)} rows="4" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="åœ¨æ­¤è¾“å…¥æœ€æ–°çš„é¡¹ç›®è¿›å±•..."/></div></div><footer className="p-4 flex justify-end gap-4 bg-gray-50 rounded-b-xl"><button onClick={onClose} className="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">å–æ¶ˆ</button><button onClick={handleSave} className="px-6 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 font-semibold">ä¿å­˜è¿›å±•</button></footer></div></div>);
};

// --- Complete Task Modal ---
const CompleteTaskModal = ({ isOpen, onClose, onConfirm, task }) => {
    const [completionDate, setCompletionDate] = useState(formatDate(new Date()));
    if (!isOpen) return null;
    return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-white text-gray-800 rounded-xl shadow-2xl w-full max-w-md"><header className="p-4"><h2 className="text-xl font-bold text-gray-900">å®Œæˆä»»åŠ¡</h2><p className="text-sm text-gray-500 mt-1">è¯·ç¡®è®¤ä»»åŠ¡ "{task?.projectName}" çš„å®é™…å®Œæˆæ—¥æœŸã€‚</p></header><div className="p-4"><label className="block text-sm font-medium text-gray-600 mb-1">å®é™…å®Œæˆæ—¥æœŸ</label><input type="date" value={completionDate} onChange={(e) => setCompletionDate(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" /></div><footer className="p-4 flex justify-end gap-4 bg-gray-50 rounded-b-xl"><button onClick={onClose} className="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">å–æ¶ˆ</button><button onClick={() => onConfirm(task, completionDate)} className="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">ç¡®è®¤å®Œæˆ</button></footer></div></div>);
};

// --- Filter Component (Reusable for Stats and Export) ---
const TaskFilter = ({ tasks, onFilterChange, managementData }) => {
    const [filters, setFilters] = useState({ taskType: 'all', department: 'all', salesPerson: 'all', projectManager: 'all', dateFilterType: 'createdAt', startDate: '', endDate: '', archiveStatus: 'all' });
    
    useEffect(() => { onFilterChange(filters); }, [filters, onFilterChange]);
    const handleFilterChange = (e) => { const { name, value } = e.target; setFilters(prev => ({ ...prev, [name]: value })); };
    
    return (<div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6"><select name="taskType" value={filters.taskType} onChange={handleFilterChange} className="bg-gray-100 border-gray-300 rounded-md px-3 py-2 text-gray-800"><option value="all">æ‰€æœ‰ä»»åŠ¡ç±»å‹</option>{[...new Set(tasks.map(t => t.taskType))].map(t => <option key={t} value={t}>{t}</option>)}</select><select name="department" value={filters.department} onChange={handleFilterChange} className="bg-gray-100 border-gray-300 rounded-md px-3 py-2 text-gray-800"><option value="all">æ‰€æœ‰éƒ¨é—¨</option>{managementData.departments.map(d => <option key={d} value={d}>{d}</option>)}</select><select name="salesPerson" value={filters.salesPerson} onChange={handleFilterChange} className="bg-gray-100 border-gray-300 rounded-md px-3 py-2 text-gray-800"><option value="all">æ‰€æœ‰ä¸šåŠ¡äººå‘˜</option>{managementData.salesPersons.map(p => <option key={p} value={p}>{p}</option>)}</select><select name="projectManager" value={filters.projectManager} onChange={handleFilterChange} className="bg-gray-100 border-gray-300 rounded-md px-3 py-2 text-gray-800"><option value="all">æ‰€æœ‰é¡¹ç›®è´Ÿè´£äºº</option>{managementData.projectManagers.map(p => <option key={p} value={p}>{p}</option>)}</select><select name="archiveStatus" value={filters.archiveStatus} onChange={handleFilterChange} className="bg-gray-100 border-gray-300 rounded-md px-3 py-2 text-gray-800"><option value="all">æ‰€æœ‰å­˜æ¡£çŠ¶æ€</option><option value="archived">å·²å­˜æ¡£</option><option value="not-archived">æœªå­˜æ¡£</option></select><select name="dateFilterType" value={filters.dateFilterType} onChange={handleFilterChange} className="bg-gray-100 border-gray-300 rounded-md px-3 py-2 text-gray-800"><option value="createdAt">ä»»åŠ¡ä¸‹è¾¾æ—¶é—´</option><option value="actualCompletionDate">å®é™…å®Œæˆæ—¥æœŸ</option></select><div className="flex gap-2 col-span-2 lg:col-span-1"><input type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} className="w-full bg-gray-100 border-gray-300 rounded-md px-3 py-2 text-gray-800"/><input type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} className="w-full bg-gray-100 border-gray-300 rounded-md px-3 py-2 text-gray-800"/></div></div>);
};

// --- Statistics Modal ---
const StatisticsModal = ({ isOpen, onClose, tasks, managementData }) => {
    const [filters, setFilters] = useState(null);
    const handleFilterChange = useCallback((newFilters) => { setFilters(newFilters); }, []);
    const filteredTasks = useMemo(() => { if (!filters) return []; return tasks.filter(task => { const { taskType, department, salesPerson, projectManager, dateFilterType, startDate, endDate, archiveStatus } = filters; if (taskType !== 'all' && task.taskType !== taskType) return false; if (department !== 'all' && task.department !== department) return false; if (salesPerson !== 'all' && task.salesPerson !== salesPerson) return false; if (projectManager !== 'all' && task.projectManager !== projectManager) return false; if (archiveStatus !== 'all') { if (archiveStatus === 'archived' && !task.isArchived) return false; if (archiveStatus === 'not-archived' && task.isArchived) return false; } if (startDate) { const taskDate = new Date(task[dateFilterType]); if (!taskDate || taskDate < new Date(startDate)) return false; } if (endDate) { const taskDate = new Date(task[dateFilterType]); if (!taskDate || taskDate > new Date(endDate)) return false; } return true; }); }, [tasks, filters]);
    const totalAmount = useMemo(() => { return filteredTasks.reduce((sum, task) => { let amount = parseFloat(task.contractAmount) || 0; if (task.contractUnit === 'ä¸‡å…ƒ') { amount *= 10000; } return sum + amount; }, 0); }, [filteredTasks]);
    if (!isOpen) return null;
    return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-white text-gray-800 rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"><header className="flex justify-between items-center p-4 border-b border-gray-200"><h2 className="text-xl font-bold text-gray-900">ç»Ÿè®¡åˆ†æ</h2><button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100"><X className="text-gray-500" /></button></header><div className="p-6 overflow-y-auto"><TaskFilter tasks={tasks} onFilterChange={handleFilterChange} managementData={managementData} /><div className="flex gap-4 mb-6"><div className="p-4 bg-slate-100 rounded-lg flex-1 text-center"><div className="text-2xl font-bold text-indigo-600">{filteredTasks.length}</div><div className="text-sm text-gray-500">ä»»åŠ¡æ€»æ•°</div></div><div className="p-4 bg-slate-100 rounded-lg flex-1 text-center"><div className="text-2xl font-bold text-green-600">{totalAmount.toLocaleString('zh-CN')}</div><div className="text-sm text-gray-500">åˆåŒæ€»é‡‘é¢ (å…ƒ)</div></div></div><div className="overflow-x-auto max-h-96"><table className="w-full text-sm text-left text-gray-600"><thead className="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th className="px-4 py-2">ä»»åŠ¡ç¼–å·</th><th className="px-4 py-2">é¡¹ç›®åç§°</th><th className="px-4 py-2">é¡¹ç›®è´Ÿè´£äºº</th><th className="px-4 py-2">åˆåŒé‡‘é¢</th><th className="px-4 py-2">ä¸‹è¾¾æ—¥æœŸ</th><th className="px-4 py-2">å®Œæˆæ—¥æœŸ</th></tr></thead><tbody>{filteredTasks.map(task => (<tr key={task._id} className="bg-white border-b border-gray-200"><td className="px-4 py-2 text-gray-900">{task.customTaskId}</td><td className="px-4 py-2 text-gray-900">{task.projectName}</td><td className="px-4 py-2">{task.projectManager}</td><td className="px-4 py-2">{task.contractAmount ? `${task.contractAmount.toLocaleString('zh-CN')} ${task.contractUnit}` : 'N/A'}</td><td className="px-4 py-2">{formatDate(task.createdAt)}</td><td className="px-4 py-2">{formatDate(task.actualCompletionDate)}</td></tr>))}</tbody></table></div></div><footer className="p-4 flex justify-end gap-4 bg-gray-50 rounded-b-xl"><button onClick={() => exportData('excel', filteredTasks, "ç»Ÿè®¡ç»“æœ")} className="px-6 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold flex items-center gap-2"><Download size={16}/>ä¸‹è½½ç»Ÿè®¡ç»“æœ</button></footer></div></div>);
};

// --- Export Modal ---
const ExportModal = ({ isOpen, onClose, tasks, managementData }) => {
    const [filters, setFilters] = useState(null);
    const handleFilterChange = useCallback((newFilters) => { setFilters(newFilters); }, []);
    const filteredTasks = useMemo(() => { if (!filters) return []; return tasks.filter(task => { const { taskType, department, salesPerson, projectManager, dateFilterType, startDate, endDate, archiveStatus } = filters; if (taskType !== 'all' && task.taskType !== taskType) return false; if (department !== 'all' && task.department !== department) return false; if (salesPerson !== 'all' && task.salesPerson !== salesPerson) return false; if (projectManager !== 'all' && task.projectManager !== projectManager) return false; if (archiveStatus !== 'all') { if (archiveStatus === 'archived' && !task.isArchived) return false; if (archiveStatus === 'not-archived' && task.isArchived) return false; } if (startDate) { const taskDate = new Date(task[dateFilterType]); if (!taskDate || taskDate < new Date(startDate)) return false; } if (endDate) { const taskDate = new Date(task[dateFilterType]); if (!taskDate || taskDate > new Date(endDate)) return false; } return true; }); }, [tasks, filters]);
    if (!isOpen) return null;
    return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-white text-gray-800 rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"><header className="flex justify-between items-center p-4 border-b border-gray-200"><h2 className="text-xl font-bold text-gray-900">å¯¼å‡ºé€‰é¡¹</h2><button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100"><X className="text-gray-500" /></button></header><div className="p-6 overflow-y-auto"><div className="mb-6 border-b border-gray-200 pb-6"><h3 className="text-lg font-semibold text-gray-700 mb-4">å¿«é€Ÿå¯¼å‡º</h3><div className="flex gap-4"><button onClick={() => exportData('excel', tasks.filter(t=>t.status==='inprogress'), "è¿›è¡Œä¸­ä»»åŠ¡")} className="flex-1 px-6 py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold">å¯¼å‡ºæ‰€æœ‰è¿›è¡Œä¸­ä»»åŠ¡</button><button onClick={() => exportData('excel', tasks.filter(t=>t.status==='done'), "å·²å®Œæˆä»»åŠ¡")} className="flex-1 px-6 py-3 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">å¯¼å‡ºæ‰€æœ‰å·²å®Œæˆä»»åŠ¡</button></div></div><div><h3 className="text-lg font-semibold text-gray-700 mb-4">ç­›é€‰å¹¶å¯¼å‡º</h3><TaskFilter tasks={tasks} onFilterChange={handleFilterChange} managementData={managementData} /><div className="mt-4 p-4 bg-slate-100 rounded-lg"><p className="text-gray-600">å·²ç­›é€‰å‡º <span className="font-bold text-indigo-600">{filteredTasks.length}</span> ä¸ªä»»åŠ¡ã€‚</p></div></div></div><footer className="p-4 flex justify-end gap-4 bg-gray-50 rounded-b-xl"><div className="flex gap-2"><button onClick={() => exportData('excel', filteredTasks, "ç­›é€‰ç»“æœ")} className="px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold" disabled={filteredTasks.length === 0}>Excel</button><button onClick={() => exportData('pdf', filteredTasks, "ç­›é€‰ç»“æœ")} className="px-4 py-2 rounded-md text-white bg-red-600 hover:bg-red-700 font-semibold" disabled={filteredTasks.length === 0}>PDF</button><button onClick={() => exportData('png', filteredTasks, "ç­›é€‰ç»“æœ")} className="px-4 py-2 rounded-md text-white bg-purple-600 hover:bg-purple-700 font-semibold" disabled={filteredTasks.length === 0}>å›¾ç‰‡</button></div></footer></div></div>);
};

// --- Import Modal ---
const ImportModal = ({ isOpen, onClose, onDownloadTemplate, onImportClick }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div className="bg-white text-gray-800 rounded-xl shadow-2xl w-full max-w-md">
                <header className="flex justify-between items-center p-4 border-b border-gray-200"><h2 className="text-xl font-bold text-gray-900">å¯¼å…¥ä»»åŠ¡</h2><button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100"><X className="text-gray-500" /></button></header>
                <div className="p-6 space-y-4">
                    <p className="text-gray-600">è¯·å…ˆä¸‹è½½æ¨¡æ¿æ–‡ä»¶ï¼ŒæŒ‰ç…§æ ¼å¼å¡«å†™ä»»åŠ¡ä¿¡æ¯åï¼Œå†ä¸Šä¼ æ–‡ä»¶è¿›è¡Œæ‰¹é‡å¯¼å…¥ã€‚</p>
                    <button onClick={onDownloadTemplate} className="w-full px-6 py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold flex items-center justify-center gap-2"><Download size={16}/>ä¸‹è½½æ¨¡æ¿</button>
                    <button onClick={onImportClick} className="w-full px-6 py-3 rounded-md text-white bg-teal-600 hover:bg-teal-700 font-semibold flex items-center justify-center gap-2"><Upload size={16}/>ä¸Šä¼ æ–‡ä»¶</button>
                </div>
            </div>
        </div>
    );
};

// --- Task List Header Component ---
const ListHeader = ({ currentView }) => {
    const isDoneView = currentView === 'done';
    const gridColsClass = isDoneView ? "grid-cols-[1fr_2fr_1.5fr_1.5fr_1fr_1fr_1fr_2.5fr_1.5fr_1.5fr_1.5fr_1fr_1fr]" : "grid-cols-[1fr_2fr_1.5fr_1.5fr_1fr_1fr_1fr_2.5fr_1.5fr_1.5fr_1.5fr_1fr]";
    return (<div className={`grid ${gridColsClass} gap-4 px-4 py-3 bg-slate-200 text-xs font-semibold text-gray-500 uppercase tracking-wider sticky top-0 z-10 text-center`}><div className="truncate">ä»»åŠ¡ç¼–å·</div><div className="truncate">é¡¹ç›®åç§°</div><div className="truncate">ä»»åŠ¡ç±»å‹</div><div className="truncate">æ‰€å±éƒ¨é—¨</div><div className="truncate">åˆåŒé‡‘é¢</div><div className="truncate">ä¸šåŠ¡äººå‘˜</div><div className="truncate">é¡¹ç›®è´Ÿè´£äºº</div><div className="truncate">é¡¹ç›®è¿›å±•æƒ…å†µ</div><div className="truncate">ä»»åŠ¡ä¸‹è¾¾æ—¶é—´</div><div className="truncate">åˆåŒè§„å®šå®Œæˆæ—¥æœŸ</div>{!isDoneView && <div className="truncate">å‰©ä½™æ—¶é—´</div>}{isDoneView && <div className="truncate">å®é™…å®Œæˆæ—¥æœŸ</div>}{isDoneView && <div className="truncate">å­˜æ¡£çŠ¶æ€</div>}<div className="truncate">æ“ä½œ</div></div>);
};

// --- Task Row Component ---
const TaskRow = ({ task, onEdit, onComplete, onArchive, onOpenProgress, onVoid, currentView }) => {
    const isDoneView = currentView === 'done';
    let timeRemainingText = ''; let timeRemainingColorClass = 'text-gray-700'; let tooltipMessage = '';
    if (currentView === 'inprogress' && task.contractualDueDate) {
        const today = new Date(); today.setHours(0, 0, 0, 0); const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0);
        const diffTime = dueDate.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays < 0) { timeRemainingText = `å·²é€¾æœŸ ${-diffDays} å¤©`; timeRemainingColorClass = 'text-red-600'; tooltipMessage = `ç«çƒ§çœ‰æ¯›å•¦ï¼å†ä¸å¹²æ´»å°±è¦è¢«è€æ¿æŠ“èµ°äº†ï¼ğŸ”¥`; } 
        else if (diffDays <= 7) { timeRemainingText = `å‰©ä½™ ${diffDays} å¤©`; timeRemainingColorClass = 'text-yellow-600'; tooltipMessage = `æœ€åå†²åˆºé˜¶æ®µï¼Œèƒœåˆ©å°±åœ¨çœ¼å‰ï¼ğŸ†`; } 
        else { timeRemainingText = `å‰©ä½™ ${diffDays} å¤©`; timeRemainingColorClass = 'text-green-600'; tooltipMessage = `ç¨³ä½ï¼Œæˆ‘ä»¬èƒ½èµ¢ï¼ğŸ˜`; }
    }
    const gridColsClass = isDoneView ? "grid-cols-[1fr_2fr_1.5fr_1.5fr_1fr_1fr_1fr_2.5fr_1.5fr_1.5fr_1.5fr_1fr_1fr]" : "grid-cols-[1fr_2fr_1.5fr_1.5fr_1fr_1fr_1fr_2.5fr_1.5fr_1.5fr_1.5fr_1fr]";
    const latestProgress = useMemo(() => { if (!task.progressDetails || !Array.isArray(task.progressDetails) || task.progressDetails.length === 0) return 'æš‚æ— è¿›å±•'; const sorted = [...task.progressDetails].sort((a, b) => b.timestamp - a.timestamp); return sorted[0].text; }, [task.progressDetails]);
    return (<div className={`grid ${gridColsClass} gap-4 px-4 py-4 items-center bg-white border-b border-gray-200 text-sm text-gray-700 text-center`} title={tooltipMessage}><div className="font-mono text-xs whitespace-normal break-words" title={task.customTaskId}>{task.customTaskId}</div><div className="font-semibold text-gray-900 whitespace-normal break-words" title={task.projectName}>{task.projectName}</div><div className="whitespace-normal break-words" title={task.taskType}>{task.taskType}</div><div className="whitespace-normal break-words" title={task.department}>{task.department}</div><div className="text-green-600 font-semibold whitespace-normal break-words">{task.contractAmount ? `${task.contractAmount.toLocaleString('zh-CN')} ${task.contractUnit}` : 'N/A'}</div><div className="whitespace-normal break-words" title={task.salesPerson}>{task.salesPerson || 'N/A'}</div><div className="whitespace-normal break-words" title={task.projectManager}>{task.projectManager}</div><div onClick={() => onOpenProgress(task)} className="text-gray-500 truncate cursor-pointer hover:text-indigo-600 flex items-center justify-center gap-2" title={latestProgress}><MessageSquare size={16} />{latestProgress}</div><div className="whitespace-normal break-words">{formatDate(task.createdAt)}</div><div className="whitespace-normal break-words">{formatDate(task.contractualDueDate)}</div>{!isDoneView && <div className={`truncate font-medium ${timeRemainingColorClass}`}>{timeRemainingText || '-'}</div>}{isDoneView && <div className="truncate">{formatDate(task.actualCompletionDate)}</div>}{isDoneView && (<div className="flex justify-center items-center">{task.isArchived ? (<span className="flex items-center text-green-600"><CheckCircle size={16} className="mr-1" /> å·²å­˜æ¡£</span>) : (<button onClick={() => onArchive(task._id)} className="p-2 rounded-md text-gray-600 bg-yellow-100 hover:bg-yellow-200 transition-all flex items-center gap-1" title="å­˜æ¡£ä»»åŠ¡"><Archive size={16} /></button>)}</div>)}<div className="flex items-center justify-center gap-2"><button onClick={() => onEdit(task)} className="p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-all" title="ç¼–è¾‘"><Edit size={16} /></button>{task.status === 'inprogress' && (<><button onClick={() => onComplete(task)} className="p-2 rounded-md text-white bg-green-600 hover:bg-green-700 transition-all" title="å®Œæˆ"><Check size={16} /></button><button onClick={() => onVoid(task._id)} className="p-2 rounded-md text-white bg-red-600 hover:bg-red-700 transition-all" title="ä½œåºŸ"><Ban size={16} /></button></>)}</div></div>);
};

// --- Main App Component ---
function App() {
    const [tasks, setTasks] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [modalError, setModalError] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
    const [editingTask, setEditingTask] = useState(null);
    const [isCompleteModalOpen, setIsCompleteModalOpen] = useState(false);
    const [completingTask, setCompletingTask] = useState(null);
    const [isProgressModalOpen, setIsProgressModalOpen] = useState(false);
    const [progressTask, setProgressTask] = useState(null);
    const [isStatsModalOpen, setIsStatsModalOpen] = useState(false);
    const [isExportModalOpen, setIsExportModalOpen] = useState(false);
    const [isImportModalOpen, setIsImportModalOpen] = useState(false);
    const [currentView, setCurrentView] = useState('inprogress');
    const [departmentFilter, setDepartmentFilter] = useState('all');
    const [managementData, setManagementData] = useState({ departments: INITIAL_DEPARTMENTS, salesPersons: INITIAL_SALES_PERSONS, projectManagers: INITIAL_PROJECT_MANAGERS });
    const [tcb, setTcb] = useState({ app: null, auth: null, db: null, _: null });

    useEffect(() => {
        const init = async () => {
            try {
                await loadScript(SCRIPTS.tcb);
                const app = window.cloudbase.init(cloudbaseConfig);
                const auth = app.auth();
                const db = app.database();
                const _ = db.command;
                setTcb({ app, auth, db, _ });
                
                await auth.anonymousAuthProvider().signIn();
                setIsAuthReady(true);

            } catch (e) {
                setError("åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥å’Œç¯å¢ƒIDé…ç½®ã€‚");
                console.error(e);
                setIsLoading(false);
            }
        };
        init();
    }, []);

    useEffect(() => {
        if (!isAuthReady || !tcb.db) return;
        setIsLoading(true);

        const watcher = tcb.db.collection('tasks').watch(snapshot => {
            const tasksData = snapshot.docs.map(doc => ({ ...doc, _id: doc._id }));
            tasksData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            setTasks(tasksData);
            setIsLoading(false);
        }, err => {
            console.error("Snapshot error:", err);
            setError("æ— æ³•ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡ã€‚");
            setIsLoading(false);
        });

        return () => watcher.close();
    }, [isAuthReady, tcb.db]);

    const handleOpenModal = (task = null) => { setEditingTask(task); setIsTaskModalOpen(true); };
    const handleCloseModal = () => { setIsTaskModalOpen(false); setEditingTask(null); setModalError(null); };
    const handleOpenCompleteModal = (task) => { setCompletingTask(task); setIsCompleteModalOpen(true); };
    const handleCloseCompleteModal = () => { setIsCompleteModalOpen(false); setCompletingTask(null); };
    const handleOpenProgressModal = (task) => { setProgressTask(task); setIsProgressModalOpen(true); };
    const handleCloseProgressModal = () => { setIsProgressModalOpen(false); setProgressTask(null); };
    const handleOpenStatsModal = () => setIsStatsModalOpen(true);
    const handleCloseStatsModal = () => setIsStatsModalOpen(false);
    const handleOpenExportModal = () => setIsExportModalOpen(true);
    const handleCloseExportModal = () => setIsExportModalOpen(false);
    const handleOpenImportModal = () => setIsImportModalOpen(true);
    const handleCloseImportModal = () => setIsImportModalOpen(false);

    const handleSaveTask = async (taskData, isEdit) => {
        if (!tcb.db) return;
        setModalError(null);
        const { total } = await tcb.db.collection('tasks').where({ customTaskId: taskData.customTaskId }).count();
        if (!isEdit && total > 0) {
            setModalError(`ä»»åŠ¡ç¼–å· "${taskData.customTaskId}" å·²å­˜åœ¨ï¼Œè¯·è¾“å…¥ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ã€‚`);
            return;
        }
        const dataToSave = { ...taskData };
        if (dataToSave.contractAmount) { dataToSave.contractAmount = parseFloat(dataToSave.contractAmount); } else { delete dataToSave.contractAmount; }
        if (dataToSave.contractualDueDate) dataToSave.contractualDueDate = new Date(dataToSave.contractualDueDate);
        if (dataToSave.actualCompletionDate) dataToSave.actualCompletionDate = new Date(dataToSave.actualCompletionDate);
        
        try {
            if (isEdit) {
                const { _id, ...updateData } = dataToSave;
                await tcb.db.collection('tasks').doc(_id).update(updateData);
            } else {
                await tcb.db.collection('tasks').add(dataToSave);
            }
            handleCloseModal();
        } catch (err) {
            console.error("Save task error:", err);
            setModalError("æ— æ³•ä¿å­˜ä»»åŠ¡ã€‚");
        }
    };
    
    const handleConfirmCompleteTask = async (taskToComplete, completionDate) => {
        if (!tcb.db) return;
        try {
            await tcb.db.collection('tasks').doc(taskToComplete._id).update({ status: 'done', actualCompletionDate: new Date(completionDate) });
            handleCloseCompleteModal();
        } catch (err) {
            console.error("Complete task error:", err);
            setError("æ— æ³•æ›´æ–°ä»»åŠ¡çŠ¶æ€ã€‚");
        }
    };

    const handleArchiveTask = async (taskId) => {
        if (!tcb.db) return;
        try { await tcb.db.collection('tasks').doc(taskId).update({ isArchived: true }); }
        catch (err) { console.error("Archive task error:", err); setError("æ— æ³•å­˜æ¡£ä»»åŠ¡ã€‚"); }
    };

    const handleVoidTask = async (taskId) => {
        if (!tcb.db) return;
        try { await tcb.db.collection('tasks').doc(taskId).update({ status: 'void' }); }
        catch (err) { console.error("Void task error:", err); setError("æ— æ³•ä½œåºŸä»»åŠ¡ã€‚"); }
    };

    const handleSaveProgress = async (taskId, newProgressText) => {
        if (!tcb.db) return;
        try {
            await tcb.db.collection('tasks').doc(taskId).update({
                progressDetails: tcb._.push({ text: newProgressText, timestamp: new Date() })
            });
        } catch (err) {
            console.error("Save progress error:", err);
            setError("æ— æ³•ä¿å­˜é¡¹ç›®è¿›å±•ã€‚");
        }
    };
    
    const handleDownloadTemplate = async () => { try { await loadScript(SCRIPTS.xlsx); const templateHeaders = ["customTaskId", "projectName", "taskType", "department", "contractAmount", "contractUnit", "salesPerson", "projectManager", "contractualDueDate"]; const ws = window.XLSX.utils.aoa_to_sheet([templateHeaders]); const wb = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(wb, ws, "Tasks"); window.XLSX.writeFile(wb, "ä»»åŠ¡å¯¼å…¥æ¨¡æ¿.xlsx"); } catch (error) { console.error(error); setError('æ— æ³•åŠ è½½å¯¼å‡ºåŠŸèƒ½æ‰€éœ€çš„åº“ã€‚'); } };
    const handleImportClick = async () => { try { await loadScript(SCRIPTS.xlsx); document.getElementById('fileUploader').click(); } catch (error) { console.error(error); setError('æ— æ³•åŠ è½½å¯¼å…¥åŠŸèƒ½æ‰€éœ€çš„åº“ã€‚'); }};
    const handleFileUpload = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { const data = new Uint8Array(e.target.result); const workbook = window.XLSX.read(data, { type: 'array' }); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const json = window.XLSX.utils.sheet_to_json(worksheet); if (json.length === 0) { setError("å¯¼å…¥çš„æ–‡ä»¶ä¸ºç©ºã€‚"); return; } 
    for (const task of json) {
        await tcb.db.collection('tasks').add({
            customTaskId: task.customTaskId || '', projectName: task.projectName || '', taskType: task.taskType || TASK_TYPES[0], department: task.department || DEPARTMENTS[0],
            contractAmount: parseFloat(task.contractAmount) || null, contractUnit: task.contractUnit || 'å…ƒ', salesPerson: task.salesPerson || SALES_PERSONS[0],
            projectManager: task.projectManager || PROJECT_MANAGERS[0], contractualDueDate: task.contractualDueDate ? new Date((task.contractualDueDate - (25567 + 2)) * 86400 * 1000) : null,
            status: 'inprogress', isArchived: false, progressDetails: [], createdAt: new Date(),
        });
    }
    alert(`${json.length} ä¸ªä»»åŠ¡å·²æˆåŠŸå¯¼å…¥ï¼`); } catch (err) { console.error("Import error:", err); setError("å¯¼å…¥æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚"); } }; reader.readAsArrayBuffer(file); event.target.value = ''; };
    
    const filteredTasks = tasks.filter(task => {
        const viewMatch = task.status === currentView;
        const departmentMatch = departmentFilter === 'all' || task.department === departmentFilter;
        return viewMatch && departmentMatch;
    });

    const NavButton = ({ view, label }) => { const count = tasks.filter(t => t.status === view && (departmentFilter === 'all' || t.department === departmentFilter)).length; return (<button onClick={() => setCurrentView(view)} className={`px-4 py-2 text-sm font-semibold rounded-md transition-colors ${currentView === view ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-700 hover:text-white'}`}>{label} ({count})</button>); };
    const minWidthClass = "min-w-[2100px]";

    return (
        <div className="bg-slate-100 text-gray-800 min-h-screen font-sans">
            <input type="file" id="fileUploader" className="hidden" accept=".xlsx, .xls" onChange={handleFileUpload} />
            <TaskModal isOpen={isTaskModalOpen} onClose={handleCloseModal} onSave={handleSaveTask} task={editingTask} error={modalError} setError={setModalError} managementData={managementData} />
            <CompleteTaskModal isOpen={isCompleteModalOpen} onClose={handleCloseCompleteModal} onConfirm={handleConfirmCompleteTask} task={completingTask} />
            <ProgressModal isOpen={isProgressModalOpen} onClose={handleCloseProgressModal} onSave={handleSaveProgress} task={progressTask} />
            <StatisticsModal isOpen={isStatsModalOpen} onClose={handleCloseStatsModal} tasks={tasks} managementData={managementData} />
            <ExportModal isOpen={isExportModalOpen} onClose={handleCloseExportModal} tasks={tasks} managementData={managementData} />
            <ImportModal isOpen={isImportModalOpen} onClose={handleCloseImportModal} onDownloadTemplate={handleDownloadTemplate} onImportClick={handleImportClick} />
            
            {error && <div className="fixed top-5 left-1/2 -translate-x-1/2 z-[100] bg-red-100 border border-red-300 text-red-800 px-6 py-3 rounded-lg shadow-lg flex items-center gap-4"><AlertTriangle size={20} /><span>{error}</span><button onClick={() => setError(null)}><X size={16}/></button></div>}

            <div className="p-4 sm:p-6 md:p-8">
                <header className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                     <div className="text-center md:text-left">
                        <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ</h1>
                         <p className="text-gray-500 mt-1">ç”± React, Tencent Cloud Base å’Œ Gemini é©±åŠ¨</p>
                    </div>
                    <div className="flex items-center flex-wrap justify-center gap-2">
                        <button onClick={() => handleOpenModal()} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-md flex items-center gap-2"><Plus size={20} />æ–°å¢ä»»åŠ¡</button>
                        <button className="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-3 rounded-md flex items-center gap-2 relative"><Bell size={16} />æ¶ˆæ¯æé†’ <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span></button>
                        <button onClick={handleOpenStatsModal} className="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-3 rounded-md flex items-center gap-2"><BarChart2 size={16} />ç»Ÿè®¡</button>
                        <button onClick={handleOpenImportModal} className="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-3 rounded-md flex items-center gap-2"><Upload size={16} />å¯¼å…¥</button>
                        <button onClick={handleOpenExportModal} className="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-3 rounded-md flex items-center gap-2"><Download size={16} />å¯¼å‡º</button>
                        <button className="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-3 rounded-md flex items-center gap-2"><Settings size={16} />ç®¡ç†</button>
                    </div>
                </header>
                
                <nav className="p-2 bg-white/80 backdrop-blur-sm rounded-lg flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 shadow-sm border border-gray-200">
                    <div className="flex items-center flex-wrap justify-center gap-2 p-1.5 bg-gray-200/50 rounded-lg">
                        <NavButton view="inprogress" label="è¿›è¡Œä¸­" />
                        <NavButton view="done" label="å·²å®Œæˆ" />
                        <NavButton view="void" label="ä½œåºŸ" />
                    </div>
                    <div className="flex items-center gap-2">
                        <label htmlFor="departmentFilter" className="text-sm font-medium text-gray-600">éƒ¨é—¨:</label>
                        <select id="departmentFilter" value={departmentFilter} onChange={(e) => setDepartmentFilter(e.target.value)} className="bg-white border-gray-300 rounded-md px-3 py-2 text-gray-800 text-sm font-semibold focus:ring-2 focus:ring-indigo-500">
                            <option value="all">æ‰€æœ‰éƒ¨é—¨</option>
                            {managementData.departments.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                    </div>
                </nav>

                {isLoading ? (
                    <div className="flex justify-center items-center mt-16"><Loader className="animate-spin text-indigo-600" size={48} /><p className="ml-4 text-lg text-gray-500">æ­£åœ¨åŠ è½½ä»»åŠ¡...</p></div>
                ) : (
                    <main className="w-full bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                        <div className="overflow-x-auto">
                           <div className={minWidthClass} id="task-table-for-export">
                                <ListHeader currentView={currentView} />
                                <div>
                                    {filteredTasks.length > 0 ? (
                                        filteredTasks.map(task => (
                                            <TaskRow key={task._id} task={task} onEdit={handleOpenModal} onComplete={handleOpenCompleteModal} onArchive={handleArchiveTask} onOpenProgress={handleOpenProgressModal} onVoid={handleVoidTask} currentView={currentView} />
                                        ))
                                    ) : (
                                        <div className="text-center py-16 px-6 bg-white"><h3 className="text-xl font-semibold text-gray-700">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ</h3><p className="text-gray-500 mt-2">{currentView === 'inprogress' ? 'æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†ï¼Œæˆ–è€…æ‚¨å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–°ä»»åŠ¡ï¼' : 'è¯¥åˆ†ç±»ä¸‹æ²¡æœ‰ä»»åŠ¡ã€‚'}</p></div>
                                    )}
                                </div>
                           </div>
                        </div>
                    </main>
                )}
            </div>
        </div>
    );
}

export default App;
